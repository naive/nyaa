#!/usr/bin/env ruby

require 'rubygems' # for ruby 1.8
require './lib/nyaa' # for testing

include Curses

@opts = Nyaa::CLI.parse(ARGV)

def batch_mode
    nyaa = Nyaa::Search.new(@opts[:query], @opts[:category], @opts[:filter])
    results = nyaa.more.get_results
    results.each do |r|
      puts "o #{r.name}"
      puts "#{r.link}"
      puts
    end
    exit
end

def browser_mode
  begin
    nyaa = Nyaa::Browser.new(@opts)
  rescue Interrupt
    puts "\nInterrupt received. Exiting."
    exit
  end
end

def curses_mode
  begin
    yield
  ensure
    nocbreak
    close_screen
  end
end

# Batch mode
if @opts[:batch]
  batch_mode
end

if @opts[:curses] # use new curses interface
  nyaa = Nyaa::UI.new(@opts)
  curses_mode do
    loop do
      nyaa.header
      nyaa.content
      nyaa.footer

      case getch
      when Curses::Key::UP   then nyaa.move(0,-1)
      when Curses::Key::DOWN then nyaa.move(0,1)
      when '?' then flash
      when 'g' then flash
      when 'i' then flash
      when 'n' then flash
      when 'p' then flash
      when 'q' then break
      end
    end
  end
else # use old interface
  browser_mode
end

exit
